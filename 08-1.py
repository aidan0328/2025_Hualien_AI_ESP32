# ğŸ§ª å¯¦é©— #8-1ï¼šWS2812B å–®é¡†è—ç‡ˆé †æ™‚é‡æ—‹è½‰å‹•ç•«
# ----------------------------------------------------
# åŸ·è¡Œç’°å¢ƒï¼šMicroPython v1.24.0 on ESP32-DevKitC
# ----------------------------------------------------

import machine
import neopixel
import time

# --- ç¡¬é«”è…³ä½èˆ‡å¸¸æ•¸è¨­å®š ---
LED_PIN = 4          # WS2812B é€£æ¥çš„ GPIO
NUM_LEDS = 12        # WS2812B ç‡ˆç’°çš„ LED æ•¸é‡
POT_PIN = 36         # å¯è®Šé›»é˜»é€£æ¥çš„ GPIO (ADC1_CH0)
BUTTON_PIN = 23      # æŒ‰éˆ•é€£æ¥çš„ GPIO

# --- é¡è‰²å®šç¾© (R, G, B) ---
BLUE = (0, 0, 255)   # è—è‰²
OFF = (0, 0, 0)      # ç†„æ»…

# --- ç¡¬é«”åˆå§‹åŒ– ---

# 1. åˆå§‹åŒ– WS2812B (NeoPixel) ç‡ˆç’°
#    neopixel.NeoPixel(è…³ä½ç‰©ä»¶, LEDæ•¸é‡)
np = neopixel.NeoPixel(machine.Pin(LED_PIN), NUM_LEDS)

# 2. åˆå§‹åŒ–å¯è®Šé›»é˜»çš„ ADC (é¡æ¯”æ•¸ä½è½‰æ›å™¨)
#    ESP32 çš„ ADC è…³ä½åœ¨ GPIO32-GPIO39 ä¹‹é–“
pot = machine.ADC(machine.Pin(POT_PIN))
#    è¨­å®šè¡°æ¸›ï¼Œè®“ ADC å¯ä»¥è®€å–å®Œæ•´çš„ 0V-3.3V é›»å£“ç¯„åœ
pot.atten(machine.ADC.ATTN_11DB)
#    è¨­å®šè§£æåº¦ç‚º 12-bitï¼Œè®€å–å€¼ç¯„åœç‚º 0-4095
pot.width(machine.ADC.WIDTH_12BIT)

# 3. åˆå§‹åŒ–æŒ‰éˆ•
#    è¨­å®šç‚ºè¼¸å…¥æ¨¡å¼ï¼Œä¸¦å•Ÿç”¨å…§éƒ¨ä¸‹æ‹‰é›»é˜»
#    é€™æ¨£åœ¨æŒ‰éˆ•æœªæŒ‰ä¸‹æ™‚ï¼Œè…³ä½æœƒç©©å®šåœ¨ä½é›»ä½(0)
button = machine.Pin(BUTTON_PIN, machine.Pin.IN, machine.Pin.PULL_DOWN)

# --- è®Šæ•¸åˆå§‹åŒ– ---
current_led_index = 0  # ç›®å‰äº®ç‡ˆçš„ç´¢å¼•ï¼Œå¾ç¬¬ 0 é¡†é–‹å§‹
last_update_time = 0   # ä¸Šæ¬¡æ›´æ–°ç‡ˆå…‰çš„æ™‚é–“æˆ³è¨˜ (æ¯«ç§’)

print("å¯¦é©— #8-1 å•Ÿå‹•ï¼šå–®é¡†è—ç‡ˆé †æ™‚é‡æ—‹è½‰")
print("è½‰å‹•å¯è®Šé›»é˜»å¯èª¿æ•´æ—‹è½‰é€Ÿåº¦ã€‚")
print("æŒ‰ä¸‹ Ctrl+C ä¾†åœæ­¢ç¨‹å¼ã€‚")

# ä½¿ç”¨ try...finally ç¢ºä¿ç¨‹å¼çµæŸæ™‚èƒ½é—œé–‰æ‰€æœ‰LED
try:
    # --- ä¸»è¿´åœˆ ---
    while True:
        # --- 1. è®€å–è¼¸å…¥èˆ‡è¨ˆç®— ---
        # è®€å–å¯è®Šé›»é˜»çš„å€¼ (0-4095)
        pot_value = pot.read()

        # å°‡å¯è®Šé›»é˜»çš„å€¼æ˜ å°„åˆ°ä¸€å€‹é€Ÿåº¦å€é–“ (ä¾‹å¦‚ 50ms åˆ° 500ms)
        # pot_value=0 (é€†æ™‚é‡åˆ°åº•) -> é€Ÿåº¦æœ€å¿« (é–“éš”æœ€çŸ­)
        # pot_value=4095 -> é€Ÿåº¦æœ€æ…¢ (é–“éš”æœ€é•·)
        # update_interval = æœ€å°é–“éš” + (è®€å–æ¯”ä¾‹ * å€é–“ç¯„åœ)
        update_interval = 50 + int((pot_value / 4095) * 450)

        # è®€å–æŒ‰éˆ•ç‹€æ…‹ (åœ¨æ­¤å¯¦é©—ä¸­æœªä½¿ç”¨ï¼Œä½†å·²åˆå§‹åŒ–)
        button_state = button.value()

        # --- 2. éé˜»å¡å¼å»¶é²æª¢æŸ¥ ---
        # é€™æ˜¯å¯¦ç¾éé˜»å¡å‹•ç•«çš„æ ¸å¿ƒ
        current_time = time.ticks_ms() # ç²å–ç•¶å‰æ™‚é–“ (æ¯«ç§’)

        # æª¢æŸ¥å¾ä¸Šæ¬¡æ›´æ–°åˆ°ç¾åœ¨ï¼Œæ˜¯å¦å·²ç¶“éäº† update_interval æ‰€è¨­å®šçš„æ™‚é–“
        # time.ticks_diff() ç”¨æ–¼å®‰å…¨åœ°è¨ˆç®—æ™‚é–“å·®ï¼Œå¯é¿å…è¨ˆæ™‚å™¨æº¢ä½å•é¡Œ
        if time.ticks_diff(current_time, last_update_time) >= update_interval:
            
            # --- 3. æ›´æ–° LED å‹•ç•« ---
            last_update_time = current_time  # æ›´æ–°æœ€å¾Œæ›´æ–°æ™‚é–“

            # a. å°‡æ‰€æœ‰ç‡ˆéƒ½ç†„æ»…
            np.fill(OFF)

            # b. åªé»äº®ç•¶å‰ç´¢å¼•çš„ç‡ˆ
            np[current_led_index] = BLUE

            # c. å°‡é¡è‰²è³‡æ–™å¯«å…¥ç‡ˆç’°ä½¿å…¶ç”Ÿæ•ˆ
            np.write()

            # d. è¨ˆç®—ä¸‹ä¸€å€‹è¦äº®çš„ç‡ˆçš„ç´¢å¼•
            #    ä½¿ç”¨å–é¤˜æ•¸ (%) é‹ç®—å­ï¼Œç¢ºä¿ç´¢å¼•å€¼åœ¨ 0 åˆ° 11 ä¹‹é–“å¾ªç’°
            #    ä¾‹å¦‚ï¼š(11 + 1) % 12 = 0ï¼Œå¯¦ç¾ç’°ç‹€æ•ˆæœ
            current_led_index = (current_led_index + 1) % NUM_LEDS


# ç•¶ä½¿ç”¨è€…æŒ‰ä¸‹ Ctrl+C ä¸­æ–·ç¨‹å¼æ™‚ï¼ŒæœƒåŸ·è¡Œ finally å€å¡Š
finally:
    # --- æ¸…ç†ä½œæ¥­ ---
    # é—œé–‰æ‰€æœ‰LEDç‡ˆï¼Œé¿å…ç¨‹å¼åœæ­¢å¾Œç‡ˆé‚„äº®è‘—
    np.fill(OFF)
    np.write()
    print("\nç¨‹å¼å·²åœæ­¢ï¼Œæ‰€æœ‰LEDå·²é—œé–‰ã€‚")